@{
    ViewBag.Title = "Generar Mensualidades";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-2">

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb bg-white shadow-sm p-3 rounded mb-0">
            <li class="breadcrumb-item"><a href="/">Inicio</a></li>
            <li class="breadcrumb-item">Módulo Financiero</li>
            <li class="breadcrumb-item">Cuentas por Cobrar</li>
            <li class="breadcrumb-item active" aria-current="page">Generar Mensualidades</li>
        </ol>
    </nav>

    <!-- Encabezado + Resumen -->
    <div class="row mt-1">

        <!-- IZQUIERDA -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">

                    <div class="d-flex align-items-center justify-content-between flex-wrap">

                        <div>
                            <h2 class="h4 mb-1">
                                <i class="mdi mdi-cash-multiple mr-1 text-primary"></i>
                                Generar Mensualidades
                            </h2>
                            <p class="text-muted mb-0">
                                Genera las cuentas por cobrar de mensualidades para todos los alumnos activos.
                            </p>
                        </div>

                        <span class="badge badge-primary px-3 py-2">
                            <i class="mdi mdi-shield-check mr-1"></i>
                            Sin cargos por mora
                        </span>

                    </div>

                    <hr>

                    <ul class="mb-0 text-muted small">
                        <li>Cálculo según <strong>Curso/Nivel</strong> y <strong>Modalidad</strong> del alumno.</li>
                        <li>No se generan duplicados para el mismo mes.</li>
                        <li>Usa las opciones avanzadas sólo cuando necesites meses específicos.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- DERECHA -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-center">

                    <small class="text-uppercase text-muted font-weight-bold mb-1">
                        Período actual
                    </small>

                    <div class="d-flex align-items-center justify-content-between">

                        <div>
                            <div class="h5 mb-0" id="periodo-actual-resumen">–</div>
                            <small class="text-muted">Según la fecha del sistema</small>
                        </div>

                        <div class="rounded-circle d-flex align-items-center justify-content-center"
                             style="width:48px;height:48px;background:rgba(102,126,234,.08);">
                            <i class="mdi mdi-calendar-clock text-primary" style="font-size:28px"></i>
                        </div>

                    </div>

                    <div class="mt-3">
                        <div class="progress" style="height:6px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width:100%"></div>
                        </div>
                        <small class="text-muted d-block mt-1">
                            Recomendado: generar primero el mes actual.
                        </small>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Contenido principal -->
    <div class="row mt-2">

        <!-- MES ACTUAL -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0 h-100">

                <div class="card-header text-white border-0 rounded"
                     style="background: linear-gradient(135deg,#667eea,#764ba2);">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 h5">
                            <i class="mdi mdi-calendar-today mr-1"></i> Mes Actual
                        </h4>
                        <span class="badge badge-light text-dark">Recomendado</span>
                    </div>
                </div>

                <div class="card-body text-center">

                    <div class="mb-3">
                        <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-2"
                             style="width:70px;height:70px;background:rgba(102,126,234,.08);">
                            <i class="mdi mdi-calendar-month text-primary" style="font-size:45px"></i>
                        </div>
                    </div>

                    <p class="text-muted mb-1">Generar mensualidad de:</p>
                    <h3 class="font-weight-bold text-primary mb-3" id="mes-actual-texto">–</h3>

                    <button class="btn btn-primary btn-lg w-100 shadow-sm"
                            id="btn-generar-mes-actual">
                        <i class="mdi mdi-check-circle-outline mr-1"></i>
                        Generar Mensualidad
                    </button>

                    <small class="text-muted mt-2 d-block">
                        Se generará para todos los alumnos activos.
                    </small>

                </div>

            </div>
        </div>

        <!-- OPCIONES AVANZADAS -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0 h-100">

                <div class="card-header text-white border-0 rounded"
                     style="background:linear-gradient(135deg,#f093fb,#f5576c);">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 h5">
                            <i class="mdi mdi-tune-variant mr-1"></i> Opciones Avanzadas
                        </h4>
                        <span class="badge badge-light">Uso puntual</span>
                    </div>
                </div>

                <div class="card-body">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <p class="text-muted mb-0 small">
                            Usa esta opción si necesitas generar un mes específico distinto al actual.
                        </p>
                        <button class="btn btn-sm btn-light"
                                type="button"
                                data-toggle="collapse"
                                data-target="#collapseMesEspecifico">
                            <span class="mr-1">Mostrar</span>
                            <i class="mdi mdi-chevron-down"></i>
                        </button>
                    </div>

                    <div class="collapse mt-2" id="collapseMesEspecifico">
                        <hr class="mt-0 mb-3">

                        <h6 class="font-weight-bold mb-3">
                            <i class="mdi mdi-calendar-range mr-1 text-danger"></i>
                            Mes Específico
                        </h6>

                        <div class="row">
                            <div class="col-md-6">
                                <label class="font-weight-bold mb-1">Mes</label>
                                <select class="form-control form-control-lg" id="mes-especifico">
                                    <option value="1">Enero</option>
                                    <option value="2">Febrero</option>
                                    <option value="3">Marzo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Mayo</option>
                                    <option value="6">Junio</option>
                                    <option value="7">Julio</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="font-weight-bold mb-1">Año</label>
                                <input type="number"
                                       class="form-control form-control-lg"
                                       id="anio-especifico" min="2020" max="2030" />
                            </div>
                        </div>

                        <button class="btn btn-outline-danger btn-lg w-100 mt-4 shadow-sm"
                                id="btn-generar-mes-especifico">
                            <i class="mdi mdi-calendar-check-outline mr-1"></i>
                            Generar Mes Específico
                        </button>

                        <small class="text-muted d-block mt-2">
                            Ideal para meses pasados que quedaron pendientes o ajustes de calendario.
                        </small>

                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Panel de Resultados -->
    <div class="card shadow-sm border-0 mt-4 d-none" id="panel-resultados">
        <div class="card-header text-white bg-success border-0 rounded">
            <h4 class="mb-0 h5">
                <i class="mdi mdi-check-all mr-1"></i>
                Resultado de la generación
            </h4>
        </div>
        <div class="card-body" id="contenido-resultados"></div>
    </div>

</div>


@section Scripts {
    <script>
        $(function () {

            const meses = [
                'Enero','Febrero','Marzo','Abril','Mayo','Junio',
                'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'
            ];

            const fecha = new Date();
            const mesActual = fecha.getMonth() + 1;
            const anioActual = fecha.getFullYear();

            // Mes y período actual
            const nombreMesActual = meses[mesActual - 1];
            $('#mes-actual-texto').text(`${nombreMesActual} ${anioActual}`);
            $('#periodo-actual-resumen').text(`${nombreMesActual} ${anioActual}`);

            // Inicializar Mes Específico
            $('#mes-especifico').val(mesActual);
            $('#anio-especifico').val(anioActual);

            // Evento: Mes Actual
            $('#btn-generar-mes-actual').click(function () {
                if (!confirm(`¿Estás seguro de generar las mensualidades de ${nombreMesActual} ${anioActual}?`)) {
                    return;
                }
                generarMensualidad(mesActual, anioActual);
            });

            // Evento: Mes Específico
            $('#btn-generar-mes-especifico').click(function () {
                const mes = parseInt($('#mes-especifico').val());
                const anio = parseInt($('#anio-especifico').val());
                const nombreMes = meses[mes - 1];

                if (!confirm(`¿Estás seguro de generar las mensualidades de ${nombreMes} ${anio}?`)) {
                    return;
                }
                generarMensualidad(mes, anio);
            });
        });

        function generarMensualidad(mes, anio) {
            $.ajax({
                url: '@Url.Action("GenerarMensualidadAsync", "CuentasCobrar")',
                type: 'POST',
                data: { mes: mes, anio: anio },
                beforeSend: function () {
                    toastr.info('Generando mensualidades, por favor espere...');
                    $('button').prop('disabled', true);
                },
                success: function (response) {
                    if (response.success && response.data) {
                        mostrarResultado(response.data);
                        toastr.success('Mensualidades generadas exitosamente');
                    } else {
                        toastr.error(response.message || 'Error al generar mensualidades');
                    }
                },
                error: function (xhr) {
                    console.error('Error:', xhr);
                    const mensaje = xhr.responseJSON?.message || 'Error al comunicarse con el servidor';
                    toastr.error(mensaje);
                },
                complete: function () {
                    $('button').prop('disabled', false);
                }
            });
        }

        function mostrarResultado(data) {
            const html = `
                <div class="alert alert-success border-0 shadow-sm mb-0">
                    <div class="row text-center gy-3">
                        <div class="col-md-4">
                            <p class="fw-semibold mb-1 text-muted">Cuentas generadas</p>
                            <h3 class="text-primary mb-0">${data.totalGenerados}</h3>
                        </div>
                        <div class="col-md-4">
                            <p class="fw-semibold mb-1 text-muted">Monto total</p>
                            <h3 class="text-success mb-0">L. ${data.montoTotal.toFixed(2)}</h3>
                        </div>
                        <div class="col-md-4">
                            <p class="fw-semibold mb-1 text-muted">Período</p>
                            <h3 class="text-info mb-0">${data.nombreMes} ${data.anio}</h3>
                        </div>
                    </div>
                    <hr>
                    <p class="mb-0">
                        <i class="mdi mdi-information-outline me-1"></i>${data.mensaje}
                    </p>
                </div>
            `;

            $('#contenido-resultados').html(html);
            $('#panel-resultados').removeClass('d-none');

            $('html, body').animate({
                scrollTop: $("#panel-resultados").offset().top - 80
            }, 500);
        }
    </script>
}
